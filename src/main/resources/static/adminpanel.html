<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Panel</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        h1 {
            text-align: center;
        }

        section {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 30px;
        }

        form {
            margin-top: 10px;
        }

        input, button {
            padding: 6px;
            margin: 4px;
        }

        ul {
            list-style: none;
            padding: 0;
        }

        li {
            border-bottom: 1px solid #ddd;
            padding: 6px 0;
        }

        .delete-btn {
            margin-left: 10px;
            color: red;
            cursor: pointer;
        }

        .scrollable {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
        }
    </style>
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
<h1>Admin Panel</h1>

<!-- TEACHERS -->
<section>
    <h2>Teachers</h2>
    <form id="add-teacher-form">
        <input type="hidden" name="id" />  <!-- This is for knowing id, so we know what we edit -->
        <input type="text" name="name" placeholder="Name" required />
        <input type="text" name="title" placeholder="Title" />
        <input type="number" name="age" placeholder="Age" />
        <button type="submit" id="teacher-submit-btn">Add Teacher</button>
        <button type="button" id="teacher-cancel-btn" style="display:none;">Cancel</button>
    </form>
    <ul id="teachers-list" class="scrollable"></ul>
</section>

<!-- STUDENTS -->
<section>
    <h2>Students</h2>
    <form id="add-student-form">
        <input type="hidden" name="id" />  <!-- This is for knowing id, so we know what we edit -->
        <input type="text" name="name" placeholder="Name" required />
        <input type="text" name="student_index" placeholder="Student Index" required />
        <input type="number" name="group_lesson" placeholder="Group Lesson" />
        <input type="number" name="group_lecture" placeholder="Group Lecture" />
        <button type="submit" id="student-submit-btn">Add Student</button>
        <button type="button" id="student-cancel-btn" style="display:none;">Cancel</button>
    </form>
    <ul id="students-list" class="scrollable"></ul>
</section>

<!-- SUBJECTS -->
<section>
    <h2>Subjects</h2>
    <form id="add-subject-form">
        <input type="text" name="name" placeholder="Name" required />
        <input type="text" name="code_name" placeholder="Code Name" required />
        <input type="number" name="etcs" placeholder="ETCS" />
        <button type="submit">Add Subject</button>
    </form>
    <ul id="subjects-list" class="scrollable"></ul>
</section>

<!-- CLASSROOMS -->
<section>
    <h2>Classrooms</h2>
    <form id="add-classroom-form">
        <input type="text" name="adress" placeholder="Address" required />
        <button type="submit">Add Classroom</button>
    </form>
    <ul id="classrooms-list" class="scrollable"></ul>
</section>

<!-- ACTIVITIES -->
<section>
    <h2>Activities</h2>
    <form id="add-activity-form">
        <select name="subject_id"></select>
        <select name="teacher_id"></select>
        <select name="classroom_id"></select>
        <input type="number" name="student_count" placeholder="Student Count" />
        <label for="start_time">Start Time:</label>
        <input type="text" id="start_time" name="start_time" required>
        <input type="number" name="duration" placeholder="Duration (minutes)" required />
        <select name="activity_type">
            <option value="">Select Activity Type</option>
        </select>
        <button type="submit">Add Activity</button>
    </form>

    <!-- Filters and Sorting -->
    <div style="margin-top: 20px;">
        <h3>Filter / Sort Activities</h3>
        <input type="date" id="filter-date" />
        <input type="text" id="filter-code" placeholder="Subject Code" />
        <button onclick="applyFilters()">Apply Filter</button>
        <button onclick="clearFilters()">Clear</button>

        <div style="margin-top: 10px;">
            <strong>Sort by:</strong>
            <button onclick="sortActivities('start_time')">Date</button>
            <button onclick="sortActivities('subject.code_name')">Subject Code</button>
            <button onclick="toggleSortDirection()">Toggle ↑↓</button>
        </div>
    </div>

    <!-- List -->
    <ul id="activities-list" class="scrollable" style="margin-top: 15px;"></ul>
</section>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        flatpickr("#start_time", {
            enableTime: true,
            dateFormat: "Y-m-d\\TH:i",
            time_24hr: true
        });
    });
</script>
<script>
    // Load Data
    window.onload = async () => {
        await Promise.all([
            loadTeachers(),
            loadStudents(),
            loadSubjects(),
            loadClassrooms(),
            loadActivities(),
            loadActivityDropdowns()
        ]);
    };

    // Teacher
    const teacherForm = document.getElementById("add-teacher-form");
    const teachersList = document.getElementById("teachers-list");
    const teacherSubmitBtn = document.getElementById("teacher-submit-btn");
    const teacherCancelBtn = document.getElementById("teacher-cancel-btn");

    async function loadTeachers() {
        const res = await fetch("/data/teachers");
        const list = await res.json();

        teachersList.innerHTML = list.map(t =>
            `<li>${t.title || ''} ${t.name} (Age: ${t.age || '?'})
            <button class="edit-btn" data-id="${t.id}">Edit</button>
            <button class="delete-btn" data-id="${t.id}" data-type="teachers">Delete</button></li>`
        ).join("");
    }

    function resetTeacherForm() {
        teacherForm.reset();
        teacherForm.id.value = "";
        teacherSubmitBtn.textContent = "Add Teacher";
        teacherCancelBtn.style.display = "none";
    }

    teacherForm.onsubmit = async e => {
        e.preventDefault();
        const formData = new FormData(teacherForm);
        const id = formData.get("id");
        const data = {
            name: formData.get("name"),
            title: formData.get("title"),
            age: formData.get("age") ? Number(formData.get("age")) : null,
        };

        if (id) {
            // Edit
            await fetch(`/data/teachers/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
        } else {
            // Add
            await fetch("/data/teachers", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
        }

        resetTeacherForm();
        loadTeachers();
    };

    teacherCancelBtn.onclick = () => resetTeacherForm();

    teachersList.onclick = async e => {
        if (e.target.classList.contains("edit-btn")) {
            const id = e.target.dataset.id;
            // Fetch the single teacher data or from loaded list
            const res = await fetch("/data/teachers");
            const teachers = await res.json();
            const teacher = teachers.find(s => s.id == id);
            if (teacher) {
                teacherForm.id.value = teacher.id;
                teacherForm.name.value = teacher.name;
                teacherForm.title.value = teacher.title || "";
                teacherForm.age.value = teacher.age;
                teacherSubmitBtn.textContent = "Update Teacher";
                teacherCancelBtn.style.display = "inline-block";
            }
        }
    };

    // Student
    const studentForm = document.getElementById("add-student-form");
    const studentsList = document.getElementById("students-list");
    const studentSubmitBtn = document.getElementById("student-submit-btn");
    const studentCancelBtn = document.getElementById("student-cancel-btn");

    async function loadStudents() {
        const res = await fetch("/data/students");
        const list = await res.json();
        const ul = document.getElementById("students-list");
        ul.innerHTML = list.map(s =>
            `<li>${s.name} (Index: ${s.student_index}) — Lesson Group: ${s.group_lesson}, Lecture Group: ${s.group_lecture}
            <button class="edit-btn" data-id="${s.id}">Edit</button>
            <button class="delete-btn" data-id="${s.id}" data-type="students">Delete</button></li>`
        ).join("");
    }

    function resetStudentForm() {
        studentForm.reset();
        studentForm.id.value = "";
        studentSubmitBtn.textContent = "Add Student";
        studentCancelBtn.style.display = "none";
    }

    studentForm.onsubmit = async e => {
        e.preventDefault();
        const formData = new FormData(studentForm);
        const id = formData.get("id");
        const data = {
            name: formData.get("name"),
            student_index: formData.get("student_index"),
            group_lesson: formData.get("group_lesson") ? Number(formData.get("group_lesson")) : null,
            group_lecture: formData.get("group_lecture") ? Number(formData.get("group_lecture")) : null
        };

        if (id) {
            // Edit student
            await fetch(`/data/students/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
        } else {
            // Add student
            await fetch("/data/students", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
        }

        resetStudentForm();
        loadStudents();
    };

    studentCancelBtn.onclick = () => resetStudentForm();

    studentsList.onclick = async e => {
        if (e.target.classList.contains("edit-btn")) {
            const id = e.target.dataset.id;
            // Fetch the single student data or from loaded list
            const res = await fetch("/data/students");
            const students = await res.json();
            const student = students.find(s => s.id == id);
            if (student) {
                studentForm.id.value = student.id;
                studentForm.name.value = student.name;
                studentForm.student_index.value = student.student_index;
                studentForm.group_lesson.value = student.group_lesson || "";
                studentForm.group_lecture.value = student.group_lecture || "";
                studentSubmitBtn.textContent = "Update Student";
                studentCancelBtn.style.display = "inline-block";
            }
        }
    };

    // Subject
    const subjectForm = document.getElementById("add-subject-form");
    const subjectsList = document.getElementById("subjects-list");

    async function loadSubjects() {
        const res = await fetch("/data/subjects");
        const list = await res.json();
        subjectsList.innerHTML = list.map(s =>
            `<li>
            ${s.name} (${s.code_name}), ETCS: ${s.etcs}
            <button class="edit-btn" data-id="${s.id}">Edit</button>
            <button class="delete-btn" data-id="${s.id}" data-type="subjects">Delete</button>
            </li>`
        ).join("");
    }

    function resetSubjectForm() {
        subjectForm.reset();
        subjectForm.dataset.id = "";
        subjectForm.querySelector("button[type='submit']").textContent = "Add Subject";
    }

    subjectForm.onsubmit = async e => {
        e.preventDefault();
        const formData = new FormData(subjectForm);
        const id = subjectForm.dataset.id;
        const data = {
            name: formData.get("name"),
            code_name: formData.get("code_name"),
            etcs: formData.get("etcs") ? Number(formData.get("etcs")) : 0
        };

        if (id) {
            // Edit
            await fetch(`/data/subjects/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
        } else {
            // Add
            await fetch("/data/subjects", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
        }

        resetSubjectForm();
        loadSubjects();
    };

    subjectsList.onclick = async e => {
        if (e.target.classList.contains("edit-btn")) {
            const id = e.target.dataset.id;
            const res = await fetch("/data/subjects");
            const subjects = await res.json();
            const subject = subjects.find(s => s.id == id);
            if (subject) {
                subjectForm.name.value = subject.name;
                subjectForm.code_name.value = subject.code_name;
                subjectForm.etcs.value = subject.etcs || "";
                subjectForm.dataset.id = id;
                subjectForm.querySelector("button[type='submit']").textContent = "Update Subject";
            }
        }
    };

    // Classroom
    const classroomForm = document.getElementById("add-classroom-form");
    const classroomsList = document.getElementById("classrooms-list");

    async function loadClassrooms() {
        const res = await fetch("/data/classrooms");
        const list = await res.json();
        classroomsList.innerHTML = list.map(c =>
            `<li>${c.adress}
        <button class="edit-btn" data-id="${c.id}">Edit</button>
        <button class="delete-btn" data-id="${c.id}" data-type="classrooms">Delete</button></li>`
        ).join("");
    }

    function resetClassroomForm() {
        classroomForm.reset();
        classroomForm.dataset.id = "";
        classroomForm.querySelector("button[type='submit']").textContent = "Add Classroom";
    }

    classroomForm.onsubmit = async e => {
        e.preventDefault();
        const formData = new FormData(classroomForm);
        const id = classroomForm.dataset.id;
        const data = {
            adress: formData.get("adress"),
        };

        if (id) {
            // Edit
            await fetch(`/data/classrooms/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
        } else {
            // Add
            await fetch("/data/classrooms", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
        }

        resetClassroomForm();
        loadClassrooms();
    };

    classroomsList.onclick = async e => {
        if (e.target.classList.contains("edit-btn")) {
            const id = e.target.dataset.id;
            const res = await fetch("/data/classrooms");
            const classrooms = await res.json();
            const classroom = classrooms.find(c => c.id == id);
            if (classroom) {
                classroomForm.adress.value = classroom.adress;
                classroomForm.dataset.id = id;
                classroomForm.querySelector("button[type='submit']").textContent = "Update Classroom";
            }
        }
    };

    // Activities
    document.getElementById("add-activity-form").onsubmit = async e => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
            subject_id: formData.get("subject_id") ? Number(formData.get("subject_id")) : null,
            teacher_id: formData.get("teacher_id") ? Number(formData.get("teacher_id")) : null,
            classroom_id: formData.get("classroom_id") ? Number(formData.get("classroom_id")) : null,
            student_count: formData.get("student_count") ? Number(formData.get("student_count")) : null,
            start_time: formData.get("start_time"),
            duration: formData.get("duration") ? Number(formData.get("duration")) : null,
            type: formData.get("activity_type") ? Number(formData.get("activity_type")) : 0,
            group_number: formData.get("group_number") ? Number(formData.get("group_number")) : null,
        };

        await fetch("/data/activities", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        e.target.reset();
        loadActivities();
    };

    let allActivities = [];
    let sortField = 'start_time';
    let sortAsc = true;

    async function loadActivities() {
        const res = await fetch("/data/activities");
        allActivities = await res.json();
        renderActivities(allActivities);
    }

    function applyFilters() {
        const date = document.getElementById('filter-date').value;
        const code = document.getElementById('filter-code').value.toLowerCase();
        let filtered = [...allActivities];

        if (date) {
            filtered = filtered.filter(a => a.start_time.startsWith(date));
        }

        if (code) {
            filtered = filtered.filter(a => (a.subject?.code_name || '').toLowerCase().includes(code));
        }

        renderActivities(filtered);
    }

    function clearFilters() {
        document.getElementById('filter-date').value = '';
        document.getElementById('filter-code').value = '';
        renderActivities(allActivities);
    }

    function sortActivities(field) {
        sortField = field;
        renderActivities(allActivities);
    }

    function toggleSortDirection() {
        sortAsc = !sortAsc;
        renderActivities(allActivities);
    }

    function resolveField(obj, path) {
        return path.split('.').reduce((o, key) => (o ? o[key] : ''), obj) || '';
    }

    function renderActivities(list) {
        const listEl = document.getElementById("activities-list");
        listEl.innerHTML = '';

        const sorted = [...list].sort((a, b) => {
            const valA = resolveField(a, sortField);
            const valB = resolveField(b, sortField);
            if (valA < valB) return sortAsc ? -1 : 1;
            if (valA > valB) return sortAsc ? 1 : -1;
            return 0;
        });

        sorted.forEach(a => {
            const li = document.createElement('li');
            li.innerHTML = `
          <strong>${a.subject?.name || 'No subject'}</strong>
          (${a.subject?.code_name || '-'}) — ${new Date(a.start_time).toLocaleString()}
          <br>
          <small>${a.type || ''} with ${a.teacher?.name || 'N/A'} in ${a.classroom?.adress || 'N/A'} (${a.duration || 0} mins)</small>
          <button class="delete-btn" data-id="${a.id}" data-type="activities">Delete</button>
        `;
            listEl.appendChild(li);
        });
    }

    async function loadActivityDropdowns() {
        const [teachersRes, subjectsRes, classroomsRes, activityTypesRes] = await Promise.all([
            fetch('/data/teachers'),
            fetch('/data/subjects'),
            fetch('/data/classrooms'),
            fetch('/api/enums/activity-types')
        ]);
        const teachers = await teachersRes.json();
        const subjects = await subjectsRes.json();
        const classrooms = await classroomsRes.json();
        const activityTypes = await activityTypesRes.json();

        // Populate subjects dropdown
        const subjectSelect = document.querySelector('select[name="subject_id"]');
        subjectSelect.innerHTML = '<option value="">Select Subject</option>' + subjects.map(s =>
            `<option value="${s.id}">${s.name} (${s.code_name})</option>`
        ).join('');

        // Populate teachers dropdown
        const teacherSelect = document.querySelector('select[name="teacher_id"]');
        teacherSelect.innerHTML = `<option value="">Select Teacher</option>` + teachers.map(t =>
            `<option value="${t.id}">${t.title ? t.title + ' ' : ''}${t.name}</option>`
        ).join('');

        // Populate classrooms dropdown
        const classroomSelect = document.querySelector('select[name="classroom_id"]');
        classroomSelect.innerHTML = '<option value="">Select Classroom</option>' + classrooms.map(c =>
            `<option value="${c.id}">${c.adress}</option>`
        ).join('');

        const activityTypeSelect = document.querySelector('select[name="activity_type"]');
        activityTypeSelect.innerHTML = '<option value="">Select Activity Type</option>';
        for (const [value, name] of Object.entries(activityTypes)) {
            activityTypeSelect.innerHTML += `<option value="${value}">${name}</option>`;
        }
    }

    // Delete handler
    document.addEventListener("click", async e => {
        if (e.target.classList.contains("delete-btn")) {
            const id = e.target.dataset.id;
            const type = e.target.dataset.type;
            await fetch(`/data/${type}/${id}`, { method: "DELETE" });
            if (type === "teachers") loadTeachers();
            else if (type === "subjects") loadSubjects();
            else if (type === "classrooms") loadClassrooms();
            else if (type === "activities") loadActivities();
            else if (type === "students") loadStudents();
        }
    });
</script>
</body>
</html>